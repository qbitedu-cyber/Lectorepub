<!DOCTYPE html>
<html lang="es" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Q-BIT | Reader System</title>
    
    <!-- TAILWIND CSS & CONFIG -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        qbit: {
                            black: '#0a0a0a',
                            dark: '#171717',     // Un poco más claro que black
                            gray: '#262626',     // Gris oscuro para bordes
                            white: '#ffffff',
                            light: '#f5f5f7',    // Blanco roto para modo lectura
                            yellow: '#FACC15',   // Acento Q-BIT
                            yellowdim: '#ca8a04' // Acento oscuro
                        }
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        mono: ['Space Mono', 'monospace'],
                    },
                    animation: {
                        'pulse-fast': 'pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    }
                }
            }
        }
    </script>

    <!-- FUENTES E ICONOS -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- MOTORES DE LECTURA -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.5/jszip.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/epubjs/dist/epub.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>

    <style>
        /* Estilos base y scrollbars personalizados */
        body { @apply font-sans antialiased bg-qbit-light dark:bg-qbit-black text-qbit-black dark:text-qbit-white transition-colors duration-300; }
        
        /* Ocultar scrollbar del body pero permitir scroll */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { @apply bg-gray-300 dark:bg-gray-700 rounded; }
        ::-webkit-scrollbar-thumb:hover { @apply bg-qbit-yellow; }

        /* Loader Animation */
        .loader-bar {
            width: 4px;
            height: 24px;
            background: #FACC15;
            animation: loaderAnim 1s ease-in-out infinite;
        }
        .loader-bar:nth-child(2) { animation-delay: 0.1s; }
        .loader-bar:nth-child(3) { animation-delay: 0.2s; }
        @keyframes loaderAnim {
            0%, 100% { height: 24px; opacity: 0.5; }
            50% { height: 40px; opacity: 1; }
        }

        /* Estilos específicos del Canvas PDF para centrado */
        #pdf-render {
            @apply flex justify-center w-full overflow-auto pt-8 pb-20 px-4;
        }
        canvas {
            @apply shadow-xl max-w-full transition-shadow duration-300; 
        }
        .dark canvas {
            box-shadow: 0 0 50px -10px rgba(0,0,0,0.5);
            filter: brightness(0.9) contrast(1.1); /* Ajuste sutil para lectura nocturna */
        }

        /* EPUB styles override */
        #epub-render {
            @apply bg-white dark:bg-qbit-light w-full h-full shadow-lg;
        }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden" oncontextmenu="return false;">

    <!-- PANTALLA DE CARGA Q-BIT -->
    <div id="loader" class="fixed inset-0 z-[200] bg-qbit-light dark:bg-qbit-black flex flex-col justify-center items-center transition-opacity duration-500">
        <div class="flex gap-2 items-center mb-4">
            <div class="loader-bar"></div>
            <div class="loader-bar"></div>
            <div class="loader-bar"></div>
        </div>
        <div class="font-mono text-sm text-gray-500 dark:text-gray-400 uppercase tracking-widest animate-pulse" id="status-msg">
            INICIALIZANDO SISTEMA...
        </div>
    </div>

    <!-- NAVBAR SUPERIOR -->
    <header class="h-16 bg-white/80 dark:bg-qbit-dark/90 backdrop-blur-md border-b border-gray-200 dark:border-gray-800 flex items-center justify-between px-4 sticky top-0 z-50 shadow-sm">
        
        <!-- Marca y Título -->
        <div class="flex items-center gap-4 overflow-hidden">
            <!-- Logo Q-BIT -->
            <div class="flex items-center gap-2 flex-shrink-0">
                <div class="w-8 h-8 bg-qbit-black dark:bg-qbit-white flex items-center justify-center rounded-sm">
                    <span class="text-qbit-yellow font-bold text-lg leading-none">Q</span>
                </div>
                <span class="hidden md:block font-bold tracking-tighter text-lg">Q-BIT</span>
            </div>
            
            <!-- Separador -->
            <div class="h-6 w-px bg-gray-300 dark:bg-gray-700 hidden sm:block"></div>
            
            <!-- Info del Libro -->
            <div class="flex flex-col justify-center overflow-hidden">
                <div class="flex items-center gap-2">
                    <span id="format-tag" class="text-[10px] font-mono bg-gray-100 dark:bg-gray-800 px-1.5 py-0.5 rounded text-gray-500 dark:text-gray-400 uppercase tracking-wide">...</span>
                </div>
                <h1 id="title-display" class="text-sm font-semibold truncate max-w-[200px] sm:max-w-md">Cargando documento...</h1>
            </div>
        </div>

        <!-- Controles de Herramientas -->
        <div class="flex items-center gap-1 sm:gap-2">
            <!-- Zoom Controls -->
            <div class="hidden sm:flex items-center bg-gray-100 dark:bg-qbit-black border border-gray-200 dark:border-gray-700 rounded-lg p-0.5">
                <button onclick="zoom(-0.1)" class="w-8 h-8 flex items-center justify-center hover:bg-white dark:hover:bg-gray-800 rounded text-gray-600 dark:text-gray-300 transition-colors" title="Reducir">
                    <i data-lucide="minus" class="w-4 h-4"></i>
                </button>
                <div class="w-px h-4 bg-gray-300 dark:bg-gray-700 mx-0.5"></div>
                <button onclick="zoom(0.1)" class="w-8 h-8 flex items-center justify-center hover:bg-white dark:hover:bg-gray-800 rounded text-gray-600 dark:text-gray-300 transition-colors" title="Aumentar">
                    <i data-lucide="plus" class="w-4 h-4"></i>
                </button>
            </div>

            <!-- Theme Toggle -->
            <button id="themeToggle" class="w-9 h-9 flex items-center justify-center rounded-lg hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors">
                <i data-lucide="moon" class="w-5 h-5 block dark:hidden text-gray-600"></i>
                <i data-lucide="sun" class="w-5 h-5 hidden dark:block text-qbit-yellow"></i>
            </button>

            <!-- Close Button -->
            <button onclick="closeReader()" class="w-9 h-9 flex items-center justify-center rounded-lg bg-red-50 dark:bg-red-900/20 text-red-500 hover:bg-red-100 dark:hover:bg-red-900/40 transition-colors ml-1 sm:ml-2">
                <i data-lucide="x" class="w-5 h-5"></i>
            </button>
        </div>
    </header>

    <!-- AREA PRINCIPAL (STAGE) -->
    <main id="stage" class="flex-1 relative flex justify-center items-start overflow-hidden bg-qbit-light dark:bg-black/50">
        
        <!-- Botones Flotantes de Navegación -->
        <button onclick="changePage(-1)" class="nav-btn absolute left-4 top-1/2 -translate-y-1/2 z-40 w-12 h-12 bg-white dark:bg-qbit-dark border border-gray-200 dark:border-gray-700 shadow-xl rounded-full flex items-center justify-center text-gray-600 dark:text-gray-300 hover:text-qbit-yellow dark:hover:text-qbit-yellow hover:border-qbit-yellow dark:hover:border-qbit-yellow transition-all duration-300 opacity-0 hover:opacity-100 sm:opacity-50 sm:hover:opacity-100 hover:scale-110 hidden sm:flex">
            <i data-lucide="chevron-left" class="w-6 h-6"></i>
        </button>
        
        <button onclick="changePage(1)" class="nav-btn absolute right-4 top-1/2 -translate-y-1/2 z-40 w-12 h-12 bg-white dark:bg-qbit-dark border border-gray-200 dark:border-gray-700 shadow-xl rounded-full flex items-center justify-center text-gray-600 dark:text-gray-300 hover:text-qbit-yellow dark:hover:text-qbit-yellow hover:border-qbit-yellow dark:hover:border-qbit-yellow transition-all duration-300 opacity-0 hover:opacity-100 sm:opacity-50 sm:hover:opacity-100 hover:scale-110 hidden sm:flex">
            <i data-lucide="chevron-right" class="w-6 h-6"></i>
        </button>

        <!-- Controles Móviles (Bottom Bar) - Solo visible en móvil -->
        <div class="sm:hidden absolute bottom-6 z-50 flex items-center gap-4 bg-white/90 dark:bg-qbit-dark/90 backdrop-blur px-6 py-3 rounded-full shadow-2xl border border-gray-200 dark:border-gray-700">
            <button onclick="changePage(-1)" class="p-2"><i data-lucide="chevron-left" class="w-6 h-6 dark:text-white"></i></button>
            <span class="text-xs font-mono dark:text-gray-400">PAGINA</span>
            <button onclick="changePage(1)" class="p-2"><i data-lucide="chevron-right" class="w-6 h-6 dark:text-white"></i></button>
        </div>

        <!-- 1. Motor PDF Pro -->
        <div id="pdf-render" class="hidden h-full">
            <canvas id="the-canvas"></canvas>
        </div>

        <!-- 2. Motor EPUB -->
        <div id="epub-render" class="hidden"></div>

        <!-- 3. Motor Fallback (Google) -->
        <iframe id="fallback-frame" class="w-full h-full hidden border-none bg-white"></iframe>

    </main>

    <!-- LOGICA DEL SISTEMA -->
    <script>
        lucide.createIcons();

        // --- GESTION DE TEMA ---
        const themeToggleBtn = document.getElementById('themeToggle');
        const htmlElement = document.documentElement;

        // Cargar preferencia
        if (localStorage.getItem('theme') === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            htmlElement.classList.add('dark');
        } else {
            htmlElement.classList.remove('dark');
        }

        themeToggleBtn.addEventListener('click', () => {
            htmlElement.classList.toggle('dark');
            if (htmlElement.classList.contains('dark')) {
                localStorage.setItem('theme', 'dark');
            } else {
                localStorage.setItem('theme', 'light');
            }
        });

        // --- VARIABLES DE ESTADO ---
        let currentScale = 1.0;
        let pdfDoc = null;
        let pageNum = 1;
        let epubRendition = null;
        let mode = 'none';

        // --- INICIO AUTOMÁTICO ---
        window.onload = function() {
            const params = new URLSearchParams(window.location.search);
            const rawUrl = params.get('file') || params.get('libro');
            const title = params.get('title') || params.get('titulo');

            if (title) document.getElementById('title-display').innerText = title;

            if (rawUrl) {
                initReader(rawUrl);
            } else {
                showError("Esperando archivo...");
                // DEMO MODE: Si no hay archivo, carga un PDF de ejemplo para visualización (puedes quitar esto en prod)
                // loadPdfPro('https://raw.githubusercontent.com/mozilla/pdf.js/ba2edeae/examples/learning/helloworld.pdf');
            }
        };

        function initReader(rawUrl) {
            let url = rawUrl;
            
            // Lógica WIX
            if (url.includes("wix:document://")) {
                const parts = url.split("/");
                if(parts.length >= 5) {
                    url = `https://docs.wixstatic.com/ugd/${parts[4]}`;
                }
            }
            console.log("Q-BIT System: Loading URL ->", url);

            let ext = 'pdf';
            try { ext = url.split('?')[0].split('.').pop().toLowerCase(); } catch(e){}
            
            if(ext === 'epub') {
                loadEpub(url);
            } else {
                loadPdfPro(url);
            }
        }

        // --- MOTOR PDF ---
        async function loadPdfPro(url) {
            setMode('pdf');
            updateStatus("PDF DOC", "RENDERIZANDO VECTORIAL...");
            
            try {
                const loadingTask = pdfjsLib.getDocument(url);
                pdfDoc = await loadingTask.promise;
                
                document.getElementById('loader').classList.add('opacity-0', 'pointer-events-none');
                document.getElementById('pdf-render').classList.remove('hidden');
                document.getElementById('pdf-render').classList.add('flex');
                
                renderPdfPage(1);
            } catch (error) {
                console.warn("Q-BIT Security: Fallback triggered.");
                loadFallback(url);
            }
        }

        function renderPdfPage(num) {
            pdfDoc.getPage(num).then(page => {
                const canvas = document.getElementById('the-canvas');
                const ctx = canvas.getContext('2d');
                
                // Ajustamos escala para mejor calidad en pantallas retina
                const outputScale = window.devicePixelRatio || 1;
                const viewport = page.getViewport({scale: currentScale});
                
                canvas.width = Math.floor(viewport.width * outputScale);
                canvas.height = Math.floor(viewport.height * outputScale);
                canvas.style.width = Math.floor(viewport.width) + "px";
                canvas.style.height = Math.floor(viewport.height) + "px";
                
                const transform = outputScale !== 1 ? [outputScale, 0, 0, outputScale, 0, 0] : null;

                const renderContext = {
                    canvasContext: ctx,
                    transform: transform,
                    viewport: viewport
                };
                
                page.render(renderContext);
            });
        }

        // --- MOTOR EPUB ---
        function loadEpub(url) {
            setMode('epub');
            updateStatus("EBOOK", "FORMATO FLUIDO...");
            
            try {
                const book = ePub(url);
                epubRendition = book.renderTo("epub-render", { width: "100%", height: "100%", flow: "paginated" });
                
                document.getElementById('loader').classList.add('opacity-0', 'pointer-events-none');
                document.getElementById('epub-render').classList.remove('hidden');
                
                epubRendition.display().then(() => {
                    // Estilos Q-BIT para el contenido del EPUB
                    epubRendition.themes.register("qbit", { 
                        body: { 
                            "font-family": "Inter, sans-serif", 
                            "font-size": "18px", 
                            "color": "#111",
                            "padding": "0 20px"
                        } 
                    });
                    epubRendition.themes.select("qbit");
                });

            } catch (e) {
                loadFallback(url);
            }
        }

        // --- FALLBACK ---
        function loadFallback(url) {
            setMode('google');
            updateStatus("VIEWER", "MODO COMPATIBILIDAD...");
            
            const iframe = document.getElementById('fallback-frame');
            iframe.classList.remove('hidden');
            iframe.src = `https://docs.google.com/gview?url=${encodeURIComponent(url)}&embedded=true`;
            
            document.getElementById('loader').classList.add('opacity-0', 'pointer-events-none');
        }

        // --- UTILS ---
        function setMode(newMode) {
            mode = newMode;
            document.getElementById('pdf-render').classList.add('hidden');
            document.getElementById('pdf-render').classList.remove('flex');
            document.getElementById('epub-render').classList.add('hidden');
            document.getElementById('fallback-frame').classList.add('hidden');
        }

        function updateStatus(badge, msg) {
            document.getElementById('format-tag').innerText = badge;
            if(msg) document.getElementById('status-msg').innerText = msg;
        }

        function changePage(dir) {
            if(mode === 'pdf' && pdfDoc) {
                if(pageNum + dir >= 1 && pageNum + dir <= pdfDoc.numPages) {
                    pageNum += dir;
                    renderPdfPage(pageNum);
                    document.getElementById('pdf-render').scrollTop = 0;
                }
            } else if (mode === 'epub' && epubRendition) {
                dir > 0 ? epubRendition.next() : epubRendition.prev();
            }
        }

        function zoom(delta) {
            if(mode === 'pdf') {
                const newScale = currentScale + delta;
                if(newScale > 0.2 && newScale < 4.0) {
                    currentScale = newScale;
                    renderPdfPage(pageNum);
                }
            } else if (mode === 'epub' && epubRendition) {
                // Lógica de zoom para EPUB (simple)
                epubRendition.themes.fontSize("120%"); // Ejemplo simplificado
            }
        }

        function closeReader() {
            try {
                window.close();
            } catch(e) {}
            window.history.back();
        }

        function showError(msg) {
            document.getElementById('status-msg').innerText = msg;
            document.getElementById('status-msg').classList.add('text-red-500');
        }
    </script>
</body>
</html>
